@let user = userInfo();

<div class="profile-panel">
  <div class="panel-header">
    <div class="avatar-section">
      <h2>Perfil</h2>
      <span class="user-role">
        @if (user) {
          {{ user.roleType === 'PLAYER' ? 'Jugador' : 'Propietario' }}
        } @else {
          Usuario
        }
      </span>
      <img src="assets/images/avatar.png" alt="Avatar" class="avatar" />
    </div>
    <div class="tab-buttons tab-buttons--profile">
      <button [class.active]="activeTab() === 'info'" (click)="setTab('info')">Información</button>
      <button [class.active]="activeTab() === 'prefs'" (click)="setTab('prefs')">Preferencias</button>
    </div>
  </div>

  <div class="panel-content">
    <!-- Información del perfil -->
    @if (activeTab() === 'info') {
      @if (user) {
        <div class="profile-fields" [formGroup]="profileForm">

          <!-- Nombre -->
          <div class="profile-field">
            @if (!editingName) {
              <label>Nombre</label>
              <span>{{ user.name }}</span>
              <button type="button" (click)="editingName = !editingName">
                <i class="lni lni-pencil-1"></i>
              </button>
            } @else {
              <div class="input-group">
                <input type="text" formControlName="name" placeholder="Nuevo nombre" />
                @if (profileForm.get('name')?.touched && profileForm.get('name')?.invalid) {
                  <small>
                    @if (profileForm.get('name')?.errors?.['required']) {
                      El nombre es obligatorio
                    } @else if (profileForm.get('name')?.errors?.['minlength']) {
                      Debe tener mínimo 3 letras
                    }
                  </small>
                }
              </div>
              <button (click)="updateName()" [disabled]="isLoadingSubmitRequest()">
                @if (isLoadingSubmitRequest()) {
                  <i class="lni lni-spinner-2-sacle"></i>
                } @else {
                  <i class="lni lni-floppy-disk-1"></i>
                }
              </button>
              <button type="button" class="cancel-btn" (click)="editingName = false; profileForm.get('name')?.reset()" aria-label="Cancelar edición">
                <i class="lni lni-xmark"></i>
              </button>
            }
          </div>

          <!-- Email -->
          <div class="profile-field">
            @if (!editingEmail) {
              <label>Email</label>
              <span>{{ user.email }}</span>
              <button type="button" (click)="editingEmail = !editingEmail">
                <i class="lni lni-pencil-1"></i>
              </button>
            } @else {
              <div class="input-group">
                <input type="email" formControlName="email" placeholder="Nuevo email" />
                @if (profileForm.get('email')?.touched && profileForm.get('email')?.invalid) {
                  <small>
                    @if (profileForm.get('email')?.errors?.['required']) {
                      El correo electrónico es obligatorio
                    } @else if (profileForm.get('email')?.errors?.['invalidEmail']) {
                      Formato inválido
                    }
                  </small>
                }
              </div>
              <button (click)="updateEmail()" [disabled]="isLoadingSubmitRequest()">
                @if (isLoadingSubmitRequest()) {
                  <i class="lni lni-spinner-2-sacle"></i>
                } @else {
                  <i class="lni lni-floppy-disk-1"></i>
                }
              </button>
              <button type="button" class="cancel-btn" (click)="editingEmail = false; profileForm.get('email')?.reset()" aria-label="Cancelar edición">
                <i class="lni lni-xmark"></i>
              </button>
            }
          </div>

          <!-- Contraseña -->
          <div class="profile-field">
            @if (!editingPassword) {
              <label>Contraseña</label>
              <span>********</span>
              <button type="button" (click)="editingPassword = !editingPassword">
                <i class="lni lni-pencil-1"></i>
              </button>
            } @else {
              <div class="input-group">
                <input type="password" formControlName="password" placeholder="Nueva contraseña" />
                @if (profileForm.get('password')?.touched && profileForm.get('password')?.invalid) {
                  <small>
                    @if (profileForm.get('password')?.errors?.['required']) {
                      La contraseña es obligatoria
                    } @else if (profileForm.get('password')?.errors?.['minlength']) {
                      Mínimo 16 caracteres
                    } @else {
                      Debe incluir mayúscula, número y caracter especial
                    }
                  </small>
                }
              </div>
              <button (click)="updatePassword()" [disabled]="isLoadingSubmitRequest()">
                @if (isLoadingSubmitRequest()) {
                  <i class="lni lni-spinner-2-sacle"></i>
                } @else {
                  <i class="lni lni-floppy-disk-1"></i>
                }
              </button>
              <button type="button" class="cancel-btn" (click)="editingPassword = false; profileForm.get('password')?.reset()" aria-label="Cancelar edición">
                <i class="lni lni-xmark"></i>
              </button>
            }
          </div>

          <div class="profile-field">
            <label>Créditos</label>
            <span>{{ user.credits }}</span>
            @if (user.roleType === 'PLAYER') {
              <button (click)="openRechargeModal()">
                <i class="lni lni-dollar-circle"></i>
              </button>
            }
          </div>
        </div>
      } @else {
        <div class="view-spinner view-spinner--sm">
          <app-spinner/>
        </div>
      }
    }

    <!-- Preferencias -->
    @if (activeTab() === 'prefs') {
      <div class="preferences">
        <div class="pref-item">
          <label for="theme">Tema</label>
          <select id="theme" (change)="onThemeChange($event)">
            <option [selected]="!isDarkTheme">Claro</option>
            <option [selected]="isDarkTheme">Oscuro</option>
          </select>
        </div>
        <div class="pref-item">
          <label for="language">Idioma</label>
          <select id="language">
            <option>Español</option>
            <option>Inglés</option>
          </select>
        </div>
        <div class="prefs-footer">
          <button (click)="logout()">Cerrar sesión</button>
        </div>
      </div>
    }
  </div>
</div>

@if (showRechargeModal) {
  <app-modal [width]="'400px'" (closeModal)="closeRechargeModal()">
    <ng-container modal-header>Recargar créditos</ng-container>
    <ng-container modal-body>
      <form [formGroup]="profileForm">
        <div class="form-field">
          <div class="input-icon-wrapper">
            <input type="number" formControlName="amount" placeholder="Monto a recargar">
            <i class="lni lni-paypal icon"></i>
            @if (profileForm.get('amount')?.touched && profileForm.get('amount')?.invalid) {
              @if (profileForm.get('amount')?.errors?.['required']) {
                <small>El monto es obligatorio</small>
              }
              @if (profileForm.get('amount')?.errors?.['min']) {
                <small>El monto debe ser al menos 1</small>
              }
            }
          </div>
        </div>
      </form>
    </ng-container>
    <ng-container modal-footer>
      <button type="submit" class="button-submit" (click)="recharge()" [disabled]="isLoadingSubmitRequest()">
        @if (isLoadingSubmitRequest()) {
          <span class="spinner-default"></span>
        } @else {
          Aceptar
        }
      </button>
    </ng-container>
  </app-modal>
}
