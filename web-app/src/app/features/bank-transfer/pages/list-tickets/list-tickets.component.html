<div class="title-wrapper">
  <div class="section-title">Retiro de créditos</div>
  @if (this.currentUser()?.roleType === 'OWNER') {
    <button class="add-sport-btn" (click)="openTicketModal()" title="Crear ticket de retiro">
      <i class="lni lni-plus"></i>
    </button>
  }
</div>

@defer (prefetch on viewport) {
  @if (tickets(); as tcks) {
    <div class="cards-grid">
      @for (ticket of tcks; track ticket.id) {
        <app-ticket-card [ticket]="ticket"
                         (ticketConfirmed)="loadTickets()"
                         (ticketDeferred)="loadTickets()"/>
      } @empty {
        @if (this.currentUser()?.roleType === 'ADMIN') {
        <p>No tienes tickets de retiro solicitados</p>
      }
    }
    </div>
  } @else {
    <p>Cargando tickets de retiro...</p>
  }
} @placeholder {
  <p>Preparando carga de tickets de retiro...</p>
} @loading {
  <p>Cargando tickets de retiro...</p>
}

<!-- Modal -->
@if (showTicketModal) {
  <app-modal [width]="'400px'" [variant]="'default'" (closeModal)="closeTicketModal()">
    <ng-container modal-header>Crear ticket de retiro</ng-container>

    <ng-container modal-body>
      <div class="bank-type-toggle">
        <label>
          <input
            type="radio"
            name="bankType"
            value="asociado"
            [(ngModel)]="bankType"
            (change)="onBankTypeChange()"
          />
          Bancos Asociados
        </label>

        <label>
          <input
            type="radio"
            name="bankType"
            value="otro"
            [(ngModel)]="bankType"
            (change)="onBankTypeChange()"
          />
          Otros
        </label>
      </div>


      <form [formGroup]="ticketForm" class="form-body">
        <div class="form-field">
          <div class="input-icon-wrapper">
            <input formControlName="fullName" type="text" placeholder="Nombre completo" required/>
          </div>
          @if (ticketForm.get('fullName')?.touched && ticketForm.get('fullName')?.invalid) {
            @if (ticketForm.get('fullName')?.errors?.['required']) {
              <small class="reservation-form__error">Es necesario el nombre completo</small>
            }
            @if (ticketForm.get('fullName')?.errors?.['minlength']) {
              <small class="reservation-form__error">El nombre completo debe tener al menos 5 caracteres</small>
            }
          }
        </div>

        <div class="form-field">
          <div class="input-icon-wrapper">
            @if (bankType === 'asociado') {
              <select formControlName="bankName">
                <option value="" disabled selected hidden>Banco asociado</option>
                <option value="BCP">BCP</option>
                <option value="BBVA">BBVA</option>
                <option value="Interbank">Interbank</option>
              </select>
            } @else {
              <input formControlName="bankName" type="text" placeholder="Nombre del banco"/>
            }
          </div>
          @if (ticketForm.get('bankName')?.touched && ticketForm.get('bankName')?.invalid) {
            @if (ticketForm.get('bankName')?.errors?.['required']) {
              <small class="reservation-form__error">El banco es obligatorio</small>
            }
          }
        </div>

        <div class="form-field">
          <div class="input-icon-wrapper">
            <input
              formControlName="accountNumber"
              type="text"
              [placeholder]="bankType === 'asociado' ? 'Número de cuenta' : 'Número de cuenta interbancario'"
              required
            />
          </div>
          @if (ticketForm.get('accountNumber')?.touched && ticketForm.get('accountNumber')?.invalid) {
            @if (ticketForm.get('accountNumber')?.errors?.['required']) {
              <small class="reservation-form__error">El número de cuenta es obligatorio</small>
            } @else if (ticketForm.get('accountNumber')?.errors?.['pattern']) {
              <small class="reservation-form__error">El número de cuenta solo debe contener números</small>
            } @else if (ticketForm.get('accountNumber')?.errors?.['invalidAccountNumberLength']) {
              <small class="reservation-form__error">
                La longitud del número de cuenta debe ser de
                {{ ticketForm.get('accountNumber')?.errors?.['invalidAccountNumberLength'].expectedLength }} dígitos
              </small>
            }
          }
        </div>
      </form>
    </ng-container>

    <ng-container modal-footer>
      <button type="submit" class="button-submit" (click)="submitTicketRequest()">
        @if (isLoadingSubmitRequest()) {
          <span class="spinner-default"></span>
        } @else {
          Crear
        }
      </button>
    </ng-container>
  </app-modal>
}
