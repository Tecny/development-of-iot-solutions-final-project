<section aria-labelledby="availability-heading">
  <h3 id="availability-heading">Horario de disponibilidad</h3>

  <div class="availability-container">
    @defer (on timer(500ms)) {
      <table class="availability-table">
        <thead>
        <tr>
          <th>Hora</th>
          @for (day of weekDays; track day) {
            <th>{{ TimeUtil.formatDate(day) }}</th>
          }
        </tr>
        </thead>
        <tbody>
          @for (time of timeSlots; track time) {
            <tr>
              <td class="time-label">{{ time }}</td>
              @for (day of weekDays; track day) {
                <td>
                  <button
                    type="button"
                    class="slot-box"
                    [ngClass]="{
                      'available': isAvailable(day, time),
                      'unavailable': !isAvailable(day, time),
                      'selected': isSelected(day, time)
                    }"
                    [title]="day + ' - ' + time"
                    (click)="onSlotClick(day, time)">
                  </button>
                </td>
              }
            </tr>
          }
        </tbody>
      </table>
    }

    <aside class="legend" aria-label="Leyenda de disponibilidad">
      <div class="legend-item">
        <span class="legend-box available"></span> Disponible
      </div>
      <div class="legend-item">
        <span class="legend-box unavailable"></span> Ocupado
      </div>
    </aside>
  </div>

  <footer>
    <button (click)="confirmHours()" [disabled]="selectedSlots().length === 0">
      Confirmar horas
    </button>

    @if (selectedSlots().length === 0) {
      <small class="error-message">Debes seleccionar al menos un horario antes de confirmar.</small>
    }
  </footer>
</section>

<!-- Modal -->
@if (showReservationModal) {
  <app-modal (closeModal)="closeReservationModal()">
    <ng-container modal-header>Confirmar Reserva</ng-container>

    <ng-container modal-body>
      <form [formGroup]="reservationForm">
        <label>
          Nombre de la Reserva:
          <input formControlName="reservationName" type="text" />
        </label>
        @if (reservationForm.get('reservationName')?.touched && reservationForm.get('reservationName')?.invalid) {
          @if (reservationForm.get('reservationName')?.errors?.['required']) {
            <small>El nombre de la reserva es obligatorio</small>
          }
          @if (reservationForm.get('reservationName')?.errors?.['minlength']) {
            <small>El nombre debe tener al menos 5 caracteres</small>
          }
        }

        <label>
          Tipo de Reserva:
          <select formControlName="type">
            <option value="PERSONAL">Personal</option>
            <option value="COMMUNITY">Comunidad</option>
          </select>
        </label>
        @if (reservationForm.get('type')?.touched && reservationForm.get('type')?.invalid) {
          @if (reservationForm.get('type')?.errors?.['required']) {
            <small>El tipo de reserva es obligatorio</small>
          }
        }
      </form>

      <section>
        <div>Día de juego: {{ TimeUtil.formatDate(selectedGameDay) }}</div>
        <div>
          Horario seleccionado:
          <ul>
            <li>{{ selectedStartTime }} - {{ selectedEndTime }}</li>
          </ul>
        </div>
        <div>
          Costo de la reserva: {{ totalCost() }} créditos
          @switch (reservationType()) {
            @case ('PERSONAL'){
              <small>(Adelanto del 50%)</small>
            }
            @case ('COMMUNITY') {
              <small>(Adelanto por persona)</small>
            }
          }
        </div>
      </section>
    </ng-container>

    <ng-container modal-footer>
      <button (click)="submitReservation()" [disabled]="reservationForm.invalid">Reservar</button>
      <button (click)="closeReservationModal()">Cancelar</button>
    </ng-container>
  </app-modal>
}
