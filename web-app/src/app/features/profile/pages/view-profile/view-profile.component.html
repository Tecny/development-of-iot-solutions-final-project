@let user = userInfo();
@if (user) {
  <div class="profile-panel">
    <div class="panel-header">
      <div class="avatar-section">
        <h2>Perfil</h2>
        <span class="user-role">{{ user.roleType === 'PLAYER' ? 'Jugador' : 'Propietario' }}</span>
        <img src="assets/images/avatar.png" alt="Avatar" class="avatar" />
      </div>
      <div class="tab-buttons">
        <button [class.active]="activeTab === 'info'" (click)="activeTab = 'info'">Información</button>
        <button [class.active]="activeTab === 'prefs'" (click)="activeTab = 'prefs'">Preferencias</button>
      </div>
    </div>

    <div class="panel-content" [formGroup]="profileForm">
      <!-- Información del perfil -->
      @if (activeTab === 'info') {
        <div class="profile-fields">

          <!-- Nombre -->
          <div class="profile-field">
            @if (!editingName) {
              <label>Nombre</label>
              <span>{{ user.name }}</span>
              <button type="button" (click)="editingName = !editingName">
                <i class="lni lni-pencil-1"></i>
              </button>
            } @else {
              <div class="input-group">
                <input type="text" formControlName="name" placeholder="Nuevo nombre" />
                @if (profileForm.get('name')?.touched && profileForm.get('name')?.invalid) {
                  <small>
                    @if (profileForm.get('name')?.errors?.['required']) {
                      El nombre es obligatorio
                    } @else if (profileForm.get('name')?.errors?.['minlength']) {
                      Debe tener mínimo 3 letras
                    }
                  </small>
                }
              </div>
              <button (click)="updateName()" [disabled]="isLoading()">
                @if (isLoading()) {
                  <i class="lni lni-spinner-2-sacle"></i>
                } @else {
                  <i class="lni lni-floppy-disk-1"></i>
                }
              </button>
              <button type="button" class="cancel-btn" (click)="editingName = false; profileForm.get('name')?.reset()" aria-label="Cancelar edición">
                <i class="lni lni-xmark"></i>
              </button>
            }
          </div>

          <!-- Email -->
          <div class="profile-field">
            @if (!editingEmail) {
              <label>Email</label>
              <span>{{ user.email }}</span>
              <button type="button" (click)="editingEmail = !editingEmail">
                <i class="lni lni-pencil-1"></i>
              </button>
            } @else {
              <div class="input-group">
                <input type="email" formControlName="email" placeholder="Nuevo email" />
                @if (profileForm.get('email')?.touched && profileForm.get('email')?.invalid) {
                  <small>
                    @if (profileForm.get('email')?.errors?.['required']) {
                      El correo electrónico es obligatorio
                    } @else if (profileForm.get('email')?.errors?.['invalidEmail']) {
                      Formato inválido
                    }
                  </small>
                }
              </div>
              <button (click)="updateEmail()" [disabled]="isLoading()">
                @if (isLoading()) {
                  <i class="lni lni-spinner-2-sacle"></i>
                } @else {
                  <i class="lni lni-floppy-disk-1"></i>
                }
              </button>
              <button type="button" class="cancel-btn" (click)="editingEmail = false; profileForm.get('email')?.reset()" aria-label="Cancelar edición">
                <i class="lni lni-xmark"></i>
              </button>
            }
          </div>

          <!-- Contraseña -->
          <div class="profile-field">
            @if (!editingPassword) {
              <label>Contraseña</label>
              <span>********</span>
              <button type="button" (click)="editingPassword = !editingPassword">
                <i class="lni lni-pencil-1"></i>
              </button>
            } @else {
              <div class="input-group">
                <input type="password" formControlName="password" placeholder="Nueva contraseña" />
                @if (profileForm.get('password')?.touched && profileForm.get('password')?.invalid) {
                  <small>
                    @if (profileForm.get('password')?.errors?.['required']) {
                      La contraseña es obligatoria
                    } @else if (profileForm.get('password')?.errors?.['minlength']) {
                      Mínimo 16 caracteres
                    } @else {
                      Debe incluir mayúscula, número y caracter especial
                    }
                  </small>
                }
              </div>
              <button (click)="updatePassword()" [disabled]="isLoading()">
                @if (isLoading()) {
                  <i class="lni lni-spinner-2-sacle"></i>
                } @else {
                  <i class="lni lni-floppy-disk-1"></i>
                }
              </button>
              <button type="button" class="cancel-btn" (click)="editingPassword = false; profileForm.get('password')?.reset()" aria-label="Cancelar edición">
                <i class="lni lni-xmark"></i>
              </button>
            }
          </div>

          <div class="profile-field">
            <label>Créditos</label>
            <span>{{ user.credits }}</span>
            @if (user.roleType === 'PLAYER') {
              <button (click)="openRechargeModal()">
                <i class="lni lni-dollar-circle"></i>
              </button>
            }
          </div>
        </div>
      }

      <!-- Preferencias -->
      @if (activeTab === 'prefs') {
        <div class="preferences">
          <div class="pref-item">
            <label for="theme">Tema</label>
            <select id="theme">
              <option>Claro</option>
              <option>Oscuro</option>
            </select>
          </div>
          <div class="pref-item">
            <label for="language">Idioma</label>
            <select id="language">
              <option>Español</option>
              <option>Inglés</option>
            </select>
          </div>
          <div class="prefs-footer">
            <button (click)="logout()">Cerrar sesión</button>
          </div>
        </div>
      }
    </div>
  </div>

  @if (showRechargeModal) {
    <app-modal [width]="'400px'" (closeModal)="closeRechargeModal()">
      <ng-container modal-header>Recargar créditos</ng-container>
      <ng-container modal-body>
        <form [formGroup]="profileForm">
          <div class="form-field">
            <div class="input-icon-wrapper">
              <input type="number" formControlName="amount" placeholder="Monto a recargar">
              <i class="lni lni-paypal icon"></i>
              @if (profileForm.get('amount')?.touched && profileForm.get('amount')?.invalid) {
                @if (profileForm.get('amount')?.errors?.['required']) {
                  <small>El monto es obligatorio</small>
                }
                @if (profileForm.get('amount')?.errors?.['min']) {
                  <small>El monto debe ser al menos 1</small>
                }
              }
            </div>
          </div>
        </form>
      </ng-container>
      <ng-container modal-footer>
        <button class="button-submit" (click)="recharge()" [disabled]="isLoading()">
          @if (isLoading()) {
          <span class="spinner"></span>
          } @else {
            Aceptar
          }
        </button>
      </ng-container>
    </app-modal>
  }
} @else {
  <div class="profile-skeleton-wrapper">
    <p class="profile-skeleton-title">Cargando perfil…</p>

    <div class="profile-skeleton-card">
      <div class="profile-skeleton-header">
        <div class="profile-skeleton-img"></div>
        <div class="profile-skeleton-details">
          <span class="profile-skeleton-name"></span>
          <span class="profile-skeleton-about"></span>
        </div>
      </div>
      <div class="profile-skeleton-description">
        <div class="profile-skeleton-line line-1"></div>
        <div class="profile-skeleton-line line-2"></div>
        <div class="profile-skeleton-line line-3"></div>
      </div>
      <div class="profile-skeleton-btns">
        <div class="profile-skeleton-btn btn-1"></div>
        <div class="profile-skeleton-btn btn-2"></div>
      </div>
    </div>
  </div>
}
